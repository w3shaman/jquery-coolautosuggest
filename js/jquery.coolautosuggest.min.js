/**
 * jQuery Plugin for creating AJAX auto-suggest textfield
 * @version 2.3.2
 * @requires jQuery 1.4 or later
 *
 * Copyright (c) 2017 Lucky
 * Licensed under the GPL license:
 *   http://www.gnu.org/licenses/gpl.html
 */

(function(a){function b(v,t){var h=v.divId;var p=false;var f=null;var o=t;var m;var j=true;o.after('<div class="'+v.divClass+'" id="'+h+'"></div>');o.attr("autocomplete","off");var n=o.next("#"+h);n.hide();if(v.width==null){v.width=o.width()+3}if(v.idField!=null||v.submitOnSelect==true||v.preventEnter==true){o.keypress(function(x){if(x.keyCode==13){return false}return true})}var l=0;var u=v.rowIdPrefix;var q=v.rowClass;var g=v.rowTextClass;var s="";var w=this;o.keyup(function(y){if(a.inArray(y.keyCode,[37,38,39,40,13,9,16,17,18])==-1){if(a(this).val().length>=v.minChars){s="";if(typeof v.additionalFields=="object"){for(var x in v.additionalFields){s=s+x+encodeURI(v.additionalFields[x].val())}}a.ajax({url:v.url+encodeURI(a(this).val())+s,success:function(C){try{if(typeof C=="string"){f=a.parseJSON(C)}else{if(typeof C=="object"){f=C}}var E=f;var D="";l=0;if(E==null){w.hide()}else{if(E.length>0){for(i=0;i<E.length;i++){cssClass=q;if(i==0){cssClass+=" first"}if(i==(E.length-1)){cssClass+=" last"}var B="";if(v.idField!=null){B=' id_field="'+E[i].id+'"'}var z="";if(v.showThumbnail==true){var A="";if(E[i].thumbnail!=undefined){A=' style="background-image:url('+E[i].thumbnail+');"'}z='<div class="'+v.rowThumbnailClass+'"'+A+"></div>"}var F="";if(v.showDescription==true){if(E[i].description!=undefined){F='<div class="'+v.rowDescriptionClass+'">'+E[i].description+"</div>"}}D+='<div id="'+u+(i+1)+'" class="'+cssClass+'"'+B+' seq_id="'+i+'" >'+z+'<div class="'+g+'">'+E[i].data.replace(new RegExp("("+d(o.val())+")","gi"),"<b>$1</b>")+"</div>"+F+"</div>"}n.html(D);for(i=1;i<=E.length;i++){var H=n.find("#"+u+i);H.bind("touchstart touchend",function(J){p=false;w.unSelectAll(this);var I=a(this);e(I);r()});H.mouseover(function(J){if(j==false){p=true;w.unSelectAll(this);var I=a(this);e(I)}});H.mouseout(function(I){p=false;w.unSelectAll(this)});H.click(function(J){var I=a(this);e(I);if(typeof v.onSelected=="function"){v.onSelected.call(this,f[I.attr("seq_id")])}r();w.hide()});H.mousemove(function(I){j=false;clearTimeout(m);m=setTimeout(c,200)})}w.show(n.find("."+q).height()*E.length)}else{w.hide()}}}catch(G){if(typeof v.onError==="function"){v.onError.call()}}},error:function(B,z,A){if(typeof v.onError==="function"){v.onError.call()}}})}else{w.hide()}}else{if(n.css("display")!="none"){k(y)}}});o.bind("blur",function(x){if(v.idField!=null){if(w.checkSelected(o.val())==false){o.val("");v.idField.val("")}}if(p==false){w.hide()}else{p=false}if(typeof v.onSelected=="function"&&l>0){v.onSelected.call(this,f[l-1]);w.hide()}});this.show=function(x){n.css({position:"fixed",left:(o.offset().left-a(document).scrollLeft())+"px",top:(o.offset().top+o.height()+5-a(document).scrollTop())+"px",height:x+"px"});n.css({width:v.width+"px"});n.find("."+q).css({width:v.width+"px",overflow:"hidden"});n.show()};this.hide=function(){n.hide()};this.unSelectAll=function(A){var z=a(A).attr("id");var y=n.find("."+q).get().length;for(i=1;i<=y;i++){n.find("#"+u+i).removeClass("selected")}l=parseInt(z.replace(u,""));var x=/^[0-9]+$/;if(!x.test(l)){l=0}};this.checkSelected=function(y){if(f!=null){for(var x=0;x<f.length;x++){if(f[x].data==y){return true}}}return false};function k(z){if(n.css("display")!="none"){var x=n.find("."+q).get().length;if(z.keyCode==40){l++;if(l<=x){var y=n.find("#"+u+l);w.unSelectAll(y);e(y)}else{l=x}}else{if(z.keyCode==38){l--;if(l>0){var y=n.find("#"+u+l);w.unSelectAll(y);e(y)}else{l=1}}else{if(z.keyCode==13){if(v.idField!=null){if(w.checkSelected(o.val())==false){o.val("");v.idField.val("")}}if(typeof v.onSelected=="function"){if(l>0){v.onSelected.call(this,f[l-1])}else{v.onSelected.call(this,null)}}w.hide()}}}}else{if(typeof v.onSelected=="function"){v.onSelected.call(this,null)}}return true}function d(x){return x.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function e(y,x){y.addClass("selected");o.val(y.find("."+g).text());if(v.idField!=null){v.idField.val(y.attr("id_field"))}}function r(){if(v.submitOnSelect==true){a("form").has(o).submit()}}function c(){j=true}}a.fn.coolautosuggest=function(c){var d={url:null,width:null,minChars:1,idField:null,submitOnSelect:false,showThumbnail:false,showDescription:false,onSelected:null,onError:function(){alert("Sorry, an error has occured!")},preventEnter:false,additionalFields:[],divId:"suggestions_holder",divClass:"suggestions",rowIdPrefix:"suggest_row",rowClass:"suggest_item",rowTextClass:"suggestion_title",rowThumbnailClass:"thumbnail",rowDescriptionClass:"description"};a.extend(d,c);return this.each(function(){var e=new b(d,a(this))})}})(jQuery);