/**
 * jQuery Plugin for creating AJAX auto-suggest textfield
 * @version 2.3.3
 * @requires jQuery 1.4 or later
 *
 * Copyright (c) 2017 Lucky
 * Licensed under the GPL license:
 *   http://www.gnu.org/licenses/gpl.html
 */

(function(a){function b(w,u){var h=w.divId;var p=false;var f=null;var o=u;var m;var j=true;o.after('<div class="'+w.divClass+'" id="'+h+'"></div>');o.attr("autocomplete","off");var n=o.next("#"+h);n.hide();if(w.width==null){w.width=o.width()+3}if(w.idField!=null||w.submitOnSelect==true||w.preventEnter==true){o.keypress(function(y){if(y.keyCode==13){return false}return true})}var l=0;var v=w.rowIdPrefix;var r=w.rowClass;var g=w.rowTextClass;var t="";var x=this;o.keyup(function(z){if(a.inArray(z.keyCode,[37,38,39,40,13,9,16,17,18])==-1){if(a(this).val().length>=w.minChars){t="";if(typeof w.additionalFields=="object"){for(var y in w.additionalFields){t=t+y+encodeURI(w.additionalFields[y].val())}}a.ajax({url:w.url+encodeURI(a(this).val())+t,success:function(D){try{if(typeof D=="string"){f=a.parseJSON(D)}else{if(typeof D=="object"){f=D}}var F=f;var E="";l=0;if(F==null){x.hide()}else{if(F.length>0){for(i=0;i<F.length;i++){cssClass=r;if(i==0){cssClass+=" first"}if(i==(F.length-1)){cssClass+=" last"}var C="";if(w.idField!=null){C=' id_field="'+F[i].id+'"'}var A="";if(w.showThumbnail==true){var B="";if(F[i].thumbnail!=undefined){B=' style="background-image:url('+F[i].thumbnail+');"'}A='<div class="'+w.rowThumbnailClass+'"'+B+"></div>"}var G="";if(w.showDescription==true){if(F[i].description!=undefined){G='<div class="'+w.rowDescriptionClass+'">'+F[i].description+"</div>"}}E+='<div id="'+v+(i+1)+'" class="'+cssClass+'"'+C+' seq_id="'+i+'" >'+A+'<div class="'+g+'">'+F[i].data.replace(new RegExp("("+d(o.val())+")","gi"),"<b>$1</b>")+"</div>"+G+"</div>"}n.html(E);for(i=1;i<=F.length;i++){var I=n.find("#"+v+i);I.bind("touchstart touchend",function(K){p=false;x.unSelectAll(this);var J=a(this);e(J);s()});I.mouseover(function(K){if(j==false){p=true;x.unSelectAll(this);var J=a(this);e(J)}});I.mouseout(function(J){p=false;x.unSelectAll(this)});I.click(function(K){var J=a(this);e(J);if(typeof w.onSelected=="function"){w.onSelected.call(this,f[J.attr("seq_id")])}s();x.hide()});I.mousemove(function(J){j=false;clearTimeout(m);m=setTimeout(c,200)})}x.show(n.find("."+r).height()*F.length)}else{x.hide()}}}catch(H){if(typeof w.onError==="function"){w.onError.call()}}},error:function(C,A,B){if(typeof w.onError==="function"){w.onError.call()}}})}else{x.hide()}}else{if(n.css("display")!="none"){k(z)}}});o.bind("blur",function(y){if(w.idField!=null){if(x.checkSelected(o.val())==false){o.val("");w.idField.val("")}}if(p==false){x.hide()}else{p=false}if(typeof w.onSelected=="function"&&l>0){w.onSelected.call(this,f[l-1]);x.hide()}});a(document).scroll(function(y){q()});this.show=function(y){q();n.css({height:y+"px",width:w.width+"px"});n.find("."+r).css({width:w.width+"px",overflow:"hidden"});n.show()};this.hide=function(){n.hide()};this.unSelectAll=function(B){var A=a(B).attr("id");var z=n.find("."+r).get().length;for(i=1;i<=z;i++){n.find("#"+v+i).removeClass("selected")}l=parseInt(A.replace(v,""));var y=/^[0-9]+$/;if(!y.test(l)){l=0}};this.checkSelected=function(z){if(f!=null){for(var y=0;y<f.length;y++){if(f[y].data==z){return true}}}return false};function k(A){if(n.css("display")!="none"){var y=n.find("."+r).get().length;if(A.keyCode==40){l++;if(l<=y){var z=n.find("#"+v+l);x.unSelectAll(z);e(z)}else{l=y}}else{if(A.keyCode==38){l--;if(l>0){var z=n.find("#"+v+l);x.unSelectAll(z);e(z)}else{l=1}}else{if(A.keyCode==13){if(w.idField!=null){if(x.checkSelected(o.val())==false){o.val("");w.idField.val("")}}if(typeof w.onSelected=="function"){if(l>0){w.onSelected.call(this,f[l-1])}else{w.onSelected.call(this,null)}}x.hide()}}}}else{if(typeof w.onSelected=="function"){w.onSelected.call(this,null)}}return true}function d(y){return y.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function e(z,y){z.addClass("selected");o.val(z.find("."+g).text());if(w.idField!=null){w.idField.val(z.attr("id_field"))}}function s(){if(w.submitOnSelect==true){a("form").has(o).submit()}}function c(){j=true}function q(){n.css({position:"fixed",left:(o.offset().left-a(document).scrollLeft())+"px",top:(o.offset().top+o.height()+5-a(document).scrollTop())+"px"})}}a.fn.coolautosuggest=function(c){var d={url:null,width:null,minChars:1,idField:null,submitOnSelect:false,showThumbnail:false,showDescription:false,onSelected:null,onError:function(){alert("Sorry, an error has occured!")},preventEnter:false,additionalFields:[],divId:"suggestions_holder",divClass:"suggestions",rowIdPrefix:"suggest_row",rowClass:"suggest_item",rowTextClass:"suggestion_title",rowThumbnailClass:"thumbnail",rowDescriptionClass:"description"};a.extend(d,c);return this.each(function(){var e=new b(d,a(this))})}})(jQuery);
