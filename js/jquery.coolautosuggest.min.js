/**
 * jQuery Plugin for creating AJAX auto-suggest textfield
 * @version 2.4.0
 * @requires jQuery 1.4 or later
 *
 * Copyright (c) 2017 Lucky
 * Licensed under the GPL license:
 *   http://www.gnu.org/licenses/gpl.html
 */

(function(a){function b(w,u){var h=w.divId;var p=false;var f=null;var o=u;var m;var j=true;o.after('<div class="'+w.divClass+'" id="'+h+'"></div>');o.attr("autocomplete","off");var n=o.next("#"+h);n.hide();if(w.width==null){w.width=o.width()+3}if(w.idField!=null||w.submitOnSelect==true||w.preventEnter==true){o.keypress(function(y){if(y.keyCode==13){return false}return true})}var l=0;var v=w.rowIdPrefix;var r=w.rowClass;var g=w.rowTextClass;var t="";var x=this;o.keyup(function(z){if(a.inArray(z.keyCode,[37,38,39,40,13,9,16,17,18])==-1){if(a(this).val().length>=w.minChars){t="";if(typeof w.additionalFields=="object"){for(var y in w.additionalFields){t=t+y+encodeURI(w.additionalFields[y].val())}}a.ajax({url:w.url+encodeURI(a(this).val())+t,beforeSend:function(){if(typeof w.onRequest==="function"){w.onRequest.call()}},complete:function(){if(typeof w.onComplete==="function"){w.onComplete.call()}},success:function(C){try{if(typeof C=="string"){f=a.parseJSON(C)}else{if(typeof C=="object"){f=C}}var E=f;var D="";l=0;if(E==null){x.hide()}else{if(E.length>0){for(i=0;i<E.length;i++){cssClass=r;var I=w.template;if(i%2!=0){cssClass+=" even"}else{cssClass+=" odd"}if(i==0){cssClass+=" first"}if(i==(E.length-1)){cssClass+=" last"}I=I.replace(/\[rowClass\]/g,cssClass);var B="";if(w.idField!=null){B=E[i].id}I=I.replace(/\[id_field\]/g,B);var A="";var K="";if(w.showThumbnail==true){if(E[i].thumbnail!=undefined){A="background-image:url("+E[i].thumbnail+");";K=w.rowThumbnailClass}}I=I.replace(/\[style\]/g,A);I=I.replace(/\[thumbnailClass\]/g,K);var F="";var J="";if(w.showDescription==true){if(E[i].description!=undefined){J=w.rowDescriptionClass;F=E[i].description}}I=I.replace(/\[descriptionClass\]/g,J);I=I.replace(/\[description\]/g,F);I=I.replace(/\[rowId\]/g,v+(i+1));I=I.replace(/\[seq_id\]/g,i);I=I.replace(/\[textClass\]/g,g);I=I.replace(/\[text\]/g,E[i].data.replace(new RegExp("("+d(o.val())+")","gi"),"<b>$1</b>"));D+=I}n.html(D);for(i=1;i<=E.length;i++){var H=n.find("#"+v+i);H.bind("touchstart touchend",function(M){p=false;x.unSelectAll(this);var L=a(this);e(L);s()});H.mouseover(function(M){if(j==false){p=true;x.unSelectAll(this);var L=a(this);e(L)}});H.mouseout(function(L){p=false;x.unSelectAll(this)});H.click(function(M){var L=a(this);e(L);if(typeof w.onSelected=="function"){w.onSelected.call(this,f[L.attr("seq_id")])}s();x.hide()});H.mousemove(function(L){j=false;clearTimeout(m);m=setTimeout(c,200)})}x.show(n.find("."+r).height()*E.length)}else{x.hide()}}}catch(G){if(typeof w.onError==="function"){w.onError.call()}}},error:function(C,A,B){if(typeof w.onError==="function"){w.onError.call()}}})}else{x.hide()}}else{if(n.css("display")!="none"){k(z)}}});o.bind("blur",function(y){if(w.idField!=null){if(x.checkSelected(o.val())==false){o.val("");w.idField.val("")}}if(p==false){x.hide()}else{p=false}if(typeof w.onSelected=="function"&&l>0){w.onSelected.call(this,f[l-1]);x.hide()}});a(document).scroll(function(y){q()});this.show=function(y){q();n.css({height:y+"px",width:w.width+"px"});n.find("."+r).css({width:w.width+"px",overflow:"hidden"});n.show()};this.hide=function(){n.hide()};this.unSelectAll=function(B){var A=a(B).attr("id");var z=n.find("."+r).get().length;for(i=1;i<=z;i++){n.find("#"+v+i).removeClass("selected")}l=parseInt(A.replace(v,""));var y=/^[0-9]+$/;if(!y.test(l)){l=0}};this.checkSelected=function(z){if(f!=null){for(var y=0;y<f.length;y++){if(f[y].data==z){return true}}}return false};function k(A){if(n.css("display")!="none"){var y=n.find("."+r).get().length;if(A.keyCode==40){l++;if(l<=y){var z=n.find("#"+v+l);x.unSelectAll(z);e(z)}else{l=y}}else{if(A.keyCode==38){l--;if(l>0){var z=n.find("#"+v+l);x.unSelectAll(z);e(z)}else{l=1}}else{if(A.keyCode==13){if(w.idField!=null){if(x.checkSelected(o.val())==false){o.val("");w.idField.val("")}}if(typeof w.onSelected=="function"){if(l>0){w.onSelected.call(this,f[l-1])}else{w.onSelected.call(this,null)}}x.hide()}}}}else{if(typeof w.onSelected=="function"){w.onSelected.call(this,null)}}return true}function d(y){return y.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function e(z,y){z.addClass("selected");o.val(z.find("."+g).text());if(w.idField!=null){w.idField.val(z.attr("id_field"))}}function s(){if(w.submitOnSelect==true){a("form").has(o).submit()}}function c(){j=true}function q(){n.css({position:"fixed",left:(o.offset().left-a(document).scrollLeft())+"px",top:(o.offset().top+o.height()+5-a(document).scrollTop())+"px"})}}a.fn.coolautosuggest=function(c){var d={url:null,width:null,minChars:1,idField:null,submitOnSelect:false,showThumbnail:false,showDescription:false,onSelected:null,onError:function(){alert("Sorry, an error has occured!")},onRequest:null,onComplete:null,preventEnter:false,additionalFields:[],divId:"suggestions_holder",divClass:"suggestions",rowIdPrefix:"suggest_row",rowClass:"suggest_item",rowTextClass:"suggestion_title",rowThumbnailClass:"thumbnail",rowDescriptionClass:"description",template:'<div id="[rowId]" class="[rowClass]" id_field="[id_field]" seq_id="[seq_id]" ><div class="[thumbnailClass]" style="[style]"></div><div class="[textClass]">[text]</div><div class="[descriptionClass]">[description]</div></div>'};a.extend(d,c);return this.each(function(){var e=new b(d,a(this))})}})(jQuery);
